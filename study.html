<!doctype html>
<html lang="en" data-theme="light">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CardCue</title>

    <link rel="stylesheet" href="styles.css" />

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8b93ff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CardCue">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/apple-touch-icon-167x167.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="icon" href="icons/favicon.ico">

    <!-- libs -->
    <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- core + shell -->
    <script defer src="version.js"></script>
    <script defer src="app.js"></script>
    <script defer src="config.js"></script>
    <script defer src="shell.js"></script>
</head>

<body>
    <app-shell id="shell" data-logo="icons/favicon-32x32.png" data-brand-offset="12">
        <main class="app-main">

            <!-- Overview -->
            <section class="panel" aria-labelledby="h-overview">
                <h2 id="h-overview" class="panel-title">Overview</h2>
                <div class="stats" style="display:flex; gap:12px; flex-wrap:wrap;">
                    <span>Total cards: <strong id="stat-cards">0</strong></span>
                    <span>Accuracy: <strong id="stat-acc">0%</strong></span>
                    <span>Wrong: <strong id="stat-wrong">0</strong></span>
                </div>
                <div class="progress" style="margin-top:8px;">
                    <div id="meter-acc" class="progress-bar" style="width:0%"></div>
                </div>
            </section>

            <!-- Learn/Test unified -->
            <section class="panel" aria-labelledby="h-study">
                <h2 id="h-study" class="panel-title">Study</h2>

                <!-- Tabs -->
                <div class="tabbar" style="margin-top:4px; display:flex; gap:6px;">
                    <button id="tab-learn" class="tab btn small active" aria-pressed="true">Learn</button>
                    <button id="tab-test" class="tab btn small" aria-pressed="false">Test</button>
                </div>

                <!-- TEST BAR (hidden by default) -->
                <div id="test-bar" class="panel" hidden>
                    <div class="chips" style="margin-bottom:8px">
                        <input class="chip" type="radio" name="test-plan" id="plan-cram" value="cram" checked>
                        <label for="plan-cram">Cram</label>

                        <input class="chip" type="radio" name="test-plan" id="plan-daily" value="daily">
                        <label for="plan-daily">Daily</label>
                    </div>

                    <div class="filters" style="grid-template-columns: repeat(auto-fit,minmax(220px,1fr));">
                        <div>
                            <label class="sr-only" for="test-type">Question type</label>
                            <select id="test-type" class="input">
                                <option value="">All</option>
                                <option value="flashcard">Flashcards</option>
                                <option value="mcq">MCQ</option>
                            </select>
                        </div>

                        <div class="switch"><input id="test-wrong" type="checkbox"><span>Wrong-only</span></div>
                        <div class="switch"><input id="test-due" type="checkbox"><span>Due now</span></div>
                        <div class="switch"><input id="test-shuffle" type="checkbox" checked><span>Shuffle</span></div>
                        <div>
                            <label class="sr-only" for="test-count">Question count</label>
                            <input id="test-count" type="number" class="input" min="1" value="20" placeholder="Count">
                        </div>
                    </div>
                </div>

                <!-- LEARN BAR (visible in Learn mode) -->
                <div id="learn-bar">
                    <!-- Shared filters -->
                    <div class="field" style="margin-top:10px;">
                        <input id="learn-search" class="input" type="search"
                            placeholder="Search text / choices / topics..." aria-label="Search cards" />
                    </div>
                    <div class="field" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                        <label>Type
                            <select id="learn-type" class="input" style="min-width:140px">
                                <option value="">All</option>
                                <option value="flashcard">Flashcards</option>
                                <option value="mcq">MCQ</option>
                            </select>
                        </label>
                        <!-- NEW: Topic dropdown -->
                        <label>Topic
                            <select id="topic-select" class="input" style="min-width:140px">
                                <option value="__ALL__">All topics</option>
                            </select>
                        </label>
                        <label class="switch"><input type="checkbox" id="learn-wrong" /> Wrong-only</label>
                        <label class="switch"><input type="checkbox" id="learn-due" /> Due now</label>
                        <label class="switch"><input type="checkbox" id="learn-shuffle" /> Shuffle</label>
                        <span id="learn-count" class="badge" aria-live="polite">0</span>
                    </div>

                    <!-- Learn UI -->
                    <div id="learn-ui">
                        <div class="tabbar" style="margin-top:4px; display:flex; gap:6px;">
                            <button id="tab-single" class="tab btn small active" aria-pressed="true">Single</button>
                            <button id="tab-grid" class="tab btn small" aria-pressed="false">Grid</button>
                        </div>

                        <!-- Single mode -->
                        <div id="learn-viewer">
                            <div class="viewer-toolbar">
                                <button id="v-prev" class="btn">◀ Previous (J)</button>
                                <button id="v-next" class="btn">Next (K) ▶</button>
                                <button id="v-peek" class="btn">Show Answer (Enter)</button>
                                <span id="v-count" class="viewer-count">0 / 0</span>
                            </div>
                            <div class="field viewer-options"
                                style="display:flex;gap:12px;align-items:center;margin:6px 0 8px;">
                                <label class="switch"><input type="checkbox" id="opt-show-exp" /> Show explanation by
                                    default</label>
                                <label class="switch"><input type="checkbox" id="opt-auto-adv" /> Auto-advance on
                                    correct</label>
                            </div>
                            <article id="v-card" class="card viewer-card reveal" tabindex="0" aria-live="polite">
                            </article>
                        </div>

                        <!-- Grid mode -->
                        <div id="learn-grid" class="card-grid" hidden></div>
                    </div>
                </div> <!-- /#learn-bar -->

                <!-- Test UI (legacy session builder; still used when Test tab is on) -->
                <div id="test-ui" hidden>
                    <div class="field"><label><input type="checkbox" id="inc-mcq" checked /> Include MCQ</label></div>
                    <div class="field"><label><input type="checkbox" id="inc-flashcards" checked /> Include
                            Flashcards</label></div>
                    <div class="field"><label><input type="checkbox" id="wrong-only" /> Wrong-only</label></div>
                    <div class="field"><label><input type="checkbox" id="shuffle" /> Shuffle</label></div>
                    <div class="field">
                        <label>Session size
                            <input id="session-size" type="number" value="20" min="1" class="input" />
                        </label>
                    </div>
                    <div class="field"><button id="btn-start" class="btn primary">Start session</button></div>
                </div>
            </section>

            <!-- Session -->
            <section class="panel" aria-labelledby="h-session">
                <h2 id="h-session" class="panel-title">Session</h2>
                <div id="session-empty">
                    <p class="placeholder">Start a session using the filters above.</p>
                </div>
                <div id="session-ui" hidden>
                    <div class="stats" style="display:flex;gap:12px;flex-wrap:wrap;">
                        <span>Card <strong id="sess-idx">0</strong> / <strong id="sess-total">0</strong></span>
                        <span>Correct: <strong id="sess-correct">0</strong></span>
                    </div>
                    <div class="progress" style="margin-top:6px;">
                        <div id="meter-progress" class="progress-bar" style="width:0%"></div>
                    </div>
                    <div id="card" class="card" style="margin-top:12px;min-height:160px;"></div>
                    <div class="field" style="margin-top:8px;">
                        <button id="btn-prev" class="btn">Previous</button>
                        <button id="btn-next" class="btn">Next</button>
                        <button id="btn-end" class="btn">End session</button>
                    </div>
                </div>
            </section>

        </main>

        <footer class="app-footer" style="padding:12px 16px; opacity:0.8; font-size:12px;">
            <span id="app-meta"></span>
            <script>
                window.addEventListener('DOMContentLoaded', () => {
                    const metaEl = document.getElementById('app-meta');
                    const ver = (window.APP && window.APP.version) || '—';
                    const date = (window.APP && window.APP.lastUpdated) || '—';
                    metaEl.textContent = `Made by Cedric · Version ${ver} · Last updated ${date}`;
                });
            </script>
        </footer>
    </app-shell>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            App.initImportExportBindings();
            App.initStudyPage();

            /** NEW: topicActive prefers dropdown */
            const topicActive = () => {
                const sel = document.getElementById('topic-select');
                if (sel && sel.value && sel.value !== '__ALL__') return sel.value;
                return '';
            };

            const searchEl = document.getElementById('learn-search');
            const typeEl = document.getElementById('learn-type');
            const wrongEl = document.getElementById('learn-wrong');
            const dueEl = document.getElementById('learn-due');
            const shuffleEl = document.getElementById('learn-shuffle');
            const countEl = document.getElementById('learn-count');

            /** Viewer */
            const viewer = App.createSingleViewer({
                getFilters() {
                    const opts = {
                        search: searchEl.value.trim(),
                        type: typeEl.value,
                        topic: topicActive(),
                        wrongOnly: wrongEl.checked,
                        dueOnly: dueEl.checked,
                        shuffle: shuffleEl.checked
                    };
                    const list = App.filterDeck(opts);
                    countEl.textContent = list.length;
                    return opts;
                },
                elements: {
                    host: document.getElementById('v-card'),
                    count: document.getElementById('v-count'),
                    btnPrev: document.getElementById('v-prev'),
                    btnNext: document.getElementById('v-next'),
                    btnPeek: document.getElementById('v-peek')
                }
            });

            /** Populate Topic dropdown */
            const topicSelect = document.getElementById('topic-select');
            if (topicSelect) {
                const topics = App.topicsList();
                topicSelect.innerHTML = ['<option value="__ALL__">All topics</option>']
                    .concat(topics.map(t => `<option value="${t}">${t}</option>`))
                    .join('');
                topicSelect.addEventListener('change', () => { viewer.apply(); renderGrid(); });
            }

            /** Grid rendering (capped at 9 cards) */
            function renderGrid() {
                const esc = s => s ? s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])) : '';
                const cards = App.filterDeck({
                    search: searchEl.value.trim(),
                    type: typeEl.value,
                    topic: topicActive(),
                    wrongOnly: wrongEl.checked,
                    dueOnly: dueEl.checked,
                    shuffle: shuffleEl.checked,
                    limit: 9
                });
                countEl.textContent = cards.length;
                const html = cards.map(c => {
                    const topics = esc((c.topics || []).join(', '));
                    if (c.type === 'mcq') {
                        const letters = ['A', 'B', 'C', 'D'];
                        const opts = (c.choices || []).map((t, i) => `<div><strong>${letters[i] || ''}.</strong> ${esc(t || '')}</div>`).join('');
                        return `<article class="card"><div class="meta"><span class="badge">${topics}</span><span class="badge">MCQ</span></div><div><strong>${esc(c.question || '')}</strong></div><div style="margin-top:6px">${opts}</div></article>`;
                    }
                    return `<article class="card"><div class="meta"><span class="badge">${topics}</span><span class="badge">Flashcard</span></div><div><strong>Front</strong><div>${esc(c.front || '')}</div></div></article>`;
                }).join('');
                document.getElementById('learn-grid').innerHTML = html || '<div class="placeholder">No cards match your filters.</div>';
            }

            /** Single/Grid switch */
            function setMode(mode) {
                const tabSingle = document.getElementById('tab-single');
                const tabGrid = document.getElementById('tab-grid');
                const wrapSingle = document.getElementById('learn-viewer');
                const wrapGrid = document.getElementById('learn-grid');
                const singleOn = (mode === 'single');
                tabSingle.classList.toggle('active', singleOn);
                tabGrid.classList.toggle('active', !singleOn);
                tabSingle.setAttribute('aria-pressed', String(singleOn));
                tabGrid.setAttribute('aria-pressed', String(!singleOn));
                wrapSingle.hidden = !singleOn;
                wrapGrid.hidden = singleOn;
                App.viewMode.set(mode);
                if (singleOn) viewer.apply(); else renderGrid();
            }

            [searchEl, typeEl, wrongEl, dueEl, shuffleEl].forEach(el => {
                el.addEventListener('input', () => { viewer.apply(); renderGrid(); });
                el.addEventListener('change', () => { viewer.apply(); renderGrid(); });
            });

            document.getElementById('tab-single').addEventListener('click', () => setMode('single'));
            document.getElementById('tab-grid').addEventListener('click', () => setMode('grid'));

            setMode(App.viewMode.get());
            viewer.apply();
        });
    </script>
</body>

</html>